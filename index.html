<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>京都旅人 Kyoto Trip (Shared)</title>
    <!-- Browser Tab Icon (Favicon) - Uses the colored system emoji -->
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⛩️</text></svg>">
    
    <!-- --- PWA / Mobile Web App Settings --- -->
    <!-- 1. iOS/Android Home Screen Icon -->
    <!-- We give this an ID so we can inject a generated PNG into it via JavaScript -->
    <link id="app-icon" rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><rect width=%22100%25%22 height=%22100%25%22 fill=%22%23FDFBF7%22/><text x=%2250%25%22 y=%2255%25%22 font-size=%2280%22 dominant-baseline=%22middle%22 text-anchor=%22middle%22>⛩️</text></svg>">
    
    <!-- 2. Web App Mode (Hides browser UI when added to home screen) -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Kyoto Trip">
    <!-- ------------------------------------- -->

    <!-- 1. Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- 2. Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        jp: {
                            bg: 'var(--jp-bg)',
                            surface: 'var(--jp-surface)',
                            text: 'var(--jp-text)',
                            gray: 'var(--jp-gray)',
                            accent: 'var(--jp-accent)',
                            red: 'var(--jp-red)',
                            blue: 'var(--jp-blue)',
                            border: 'var(--jp-border)'
                        }
                    }
                }
            }
        }
    </script>

    <!-- 3. Vue 3 (Production Build) -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    
    <!-- 4. Icons & Maps -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>

    <!-- 5. Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">

    <style>
        /* Theming Variables */
        :root {
            --jp-bg: #FDFBF7;
            --jp-surface: #FFFFFF;
            --jp-text: #433D3C;
            --jp-gray: #9E9D99;
            --jp-accent: #8E9F86;
            --jp-red: #CB7E76;
            --jp-blue: #8CA6B3;
            --jp-border: #F3F4F6;
        }

        /* Dark Mode (Gion Night) */
        [data-theme="dark"] {
            --jp-bg: #18181b;
            --jp-surface: #27272a;
            --jp-text: #e4e4e7;
            --jp-gray: #a1a1aa;
            --jp-accent: #fbbf24;
            --jp-red: #f87171;
            --jp-blue: #60a5fa;
            --jp-border: #3f3f46;
        }

        /* Sakura Mode */
        [data-theme="sakura"] {
            --jp-bg: #fff1f2;
            --jp-surface: #ffffff;
            --jp-text: #881337;
            --jp-gray: #9f1239;
            --jp-accent: #fb7185;
            --jp-red: #e11d48;
            --jp-blue: #6366f1;
            --jp-border: #fecdd3;
        }

        body {
            font-family: 'Noto Sans JP', 'Noto Sans TC', sans-serif;
            background-color: #f3f4f6; /* Light gray background for body */
            -webkit-tap-highlight-color: transparent;
            transition: background-color 0.3s ease;
        }
        
        /* Utilities */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .scrolling-touch { -webkit-overflow-scrolling: touch; }
        .snap-x-mandatory { scroll-snap-type: x mandatory; }
        .snap-center { scroll-snap-align: center; }
        .fade-enter-active, .fade-leave-active { transition: opacity 0.2s ease; }
        .fade-enter-from, .fade-leave-to { opacity: 0; }
        .slide-up-enter-active, .slide-up-leave-active { transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        .slide-up-enter-from, .slide-up-leave-to { transform: translateY(100%); }
        .accordion-enter-active, .accordion-leave-active { transition: max-height 0.3s ease, opacity 0.3s ease; max-height: 500px; overflow: hidden; }
        .accordion-enter-from, .accordion-leave-to { max-height: 0; opacity: 0; }
        .shadow-soft { box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05); }
        .shadow-float { box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1); }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom); }

        #map-container { width: 100%; z-index: 0; }
        
        .user-location-marker {
            background-color: #3B82F6;
            border: 2px solid white;
            border-radius: 50%;
            box-shadow: 0 0 0 10px rgba(59, 130, 246, 0.3);
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(59, 130, 246, 0); }
            100% { box-shadow: 0 0 0 0 rgba(59, 130, 246, 0); }
        }
    </style>
</head>
<body class="h-screen w-full overflow-hidden flex justify-center bg-gray-100 text-jp-text transition-colors duration-300">

    <div id="app" class="w-full max-w-md h-full bg-jp-bg shadow-2xl relative flex flex-col overflow-hidden font-light transition-colors duration-300">
        
        <!-- Header -->
        <header class="bg-jp-bg/95 backdrop-blur-sm z-20 px-6 py-4 flex justify-between items-end sticky top-0 h-16 border-b border-jp-border flex-none transition-colors duration-300">
            <h1 class="text-xl font-medium tracking-widest text-jp-text flex items-center gap-2">
                <span class="text-jp-red opacity-80"><i class="fa-solid fa-torii-gate"></i></span>
                {{ getTabTitle }}
                <span v-if="!isOnline" class="text-[10px] bg-red-100 text-red-500 px-1 rounded ml-1 font-bold">Offline</span>
                <span v-if="isSyncing" class="text-[10px] text-jp-accent ml-1 animate-pulse"><i class="fa-solid fa-rotate"></i></span>
            </h1>
            <button @click="showSettings = true" class="text-jp-gray hover:text-jp-accent transition mb-1">
                <i class="fa-solid fa-sliders text-lg"></i>
            </button>
        </header>

        <!-- Connection Error Banner -->
        <div v-if="errorMessage" class="bg-red-500 text-white px-4 py-3 text-xs text-center z-50 absolute top-16 left-0 right-0 shadow-md">
            <i class="fa-solid fa-circle-exclamation mr-1 text-sm"></i> {{ errorMessage }}
        </div>

        <!-- Main Content -->
        <main class="flex-1 overflow-y-auto scrolling-touch no-scrollbar relative h-full flex flex-col">
            
            <!-- Tab 1: Itinerary -->
            <div v-if="activeTab === 'itinerary'" class="pb-28">
                <div class="px-6 py-4 flex items-center justify-between text-xs text-jp-gray">
                    <span>KYOTO, JAPAN</span>
                    <span v-if="currentKyotoWeather" class="flex items-center gap-1">
                        <i :class="getWeatherIcon(currentKyotoWeather.weathercode)" class="text-sm"></i>
                        {{ currentKyotoWeather.temperature }}°C (Now)
                    </span>
                    <span v-else>Loading weather...</span>
                </div>

                <div class="flex overflow-x-auto gap-4 px-6 pb-2 no-scrollbar snap-x-mandatory mb-4">
                    <button 
                        v-for="(day, index) in days" 
                        :key="index"
                        @click="currentDayIndex = index"
                        class="snap-center flex-shrink-0 flex flex-col items-center justify-center w-14 h-20 rounded-full transition-all duration-300 relative border border-transparent"
                        :class="currentDayIndex === index ? 'bg-jp-text text-jp-bg shadow-lg scale-105' : 'bg-jp-surface text-jp-gray border-jp-border'"
                    >
                        <span class="text-[10px] uppercase tracking-wider mb-1 font-medium">{{ getDayName(day.date) }}</span>
                        <span class="text-xl font-medium">{{ new Date(day.date).getDate() }}</span>
                        <div v-if="currentDayIndex === index" class="absolute -bottom-2 w-1 h-1 bg-jp-text rounded-full"></div>
                    </button>
                    <button @click="addDay" class="snap-center flex-shrink-0 flex items-center justify-center w-14 h-20 rounded-full border border-dashed border-jp-gray/30 text-jp-gray hover:border-jp-accent hover:text-jp-accent transition">
                        <i class="fa-solid fa-plus not-italic"></i>
                    </button>
                    <div class="w-2 flex-shrink-0"></div> 
                </div>

                <div class="px-6 space-y-6">
                    <div v-if="currentDayIndex === 0 && days[0].flight" class="mb-2">
                        <div class="bg-jp-surface rounded-2xl shadow-sm border border-jp-border overflow-hidden relative group transition-all">
                            <div class="h-2 bg-jp-blue w-full"></div>
                            <div @click="toggleFlight(0)" class="p-4 flex justify-between items-center cursor-pointer bg-jp-surface z-10 relative">
                                <div class="flex items-center gap-3">
                                    <div class="w-8 h-8 rounded-full bg-blue-500/10 text-jp-blue flex items-center justify-center"><i class="fa-solid fa-plane-arrival text-sm"></i></div>
                                    <div>
                                        <div class="text-xs font-bold text-jp-gray uppercase tracking-widest">Arrival Flight</div>
                                        <div class="font-bold text-jp-text text-sm" v-if="!flightExpanded[0]">
                                            {{ days[0].flight.number || 'No Flight Info' }} 
                                            <span v-if="days[0].flight.from" class="opacity-60 font-normal"> · {{ days[0].flight.from }} <i class="fa-solid fa-arrow-right text-[10px]"></i> {{ days[0].flight.to }}</span>
                                        </div>
                                    </div>
                                </div>
                                <i class="fa-solid text-jp-gray transition-transform duration-300" :class="flightExpanded[0] ? 'fa-chevron-up rotate-0' : 'fa-chevron-down'"></i>
                            </div>
                            <transition name="accordion">
                                <div v-if="flightExpanded[0]" class="px-5 pb-5 border-t border-jp-border">
                                    <div class="mt-4 mb-4">
                                        <label class="text-[9px] text-jp-gray block mb-1 uppercase tracking-wider">Flight No.</label>
                                        <input v-model="days[0].flight.number" @input="autoFillFlight(0)" type="text" placeholder="e.g. JX820" class="w-full font-bold text-jp-text text-xl uppercase bg-transparent border-b border-jp-border focus:outline-none focus:border-jp-blue transition placeholder-gray-400">
                                    </div>
                                    <div class="grid grid-cols-2 gap-6">
                                        <div>
                                            <div class="flex items-end gap-2 mb-1"><span class="text-2xl font-bold text-jp-text">{{ days[0].flight.from || 'TPE' }}</span><span class="text-[9px] text-jp-gray mb-1">DEP</span></div>
                                            <input type="date" v-model="days[0].date" class="w-full text-[10px] bg-transparent border-none p-0 text-jp-gray mb-1 focus:ring-0">
                                            <input type="time" v-model="days[0].flight.time" class="w-full text-lg font-bold bg-transparent border-none p-0 text-jp-text focus:ring-0">
                                        </div>
                                        <div class="text-right">
                                            <div class="flex items-end justify-end gap-2 mb-1"><span class="text-[9px] text-jp-gray mb-1">ARR</span><span class="text-2xl font-bold text-jp-text">{{ days[0].flight.to || 'KIX' }}</span></div>
                                            <input type="date" v-model="days[0].flight.arrivalDate" class="w-full text-[10px] bg-transparent border-none p-0 text-jp-gray mb-1 text-right focus:ring-0">
                                            <input type="time" v-model="days[0].flight.arrivalTime" class="w-full text-lg font-bold bg-transparent border-none p-0 text-jp-text text-right focus:ring-0">
                                        </div>
                                    </div>
                                    <div class="mt-4 flex items-center justify-center opacity-20"><div class="h-[1px] w-full bg-jp-text"></div><i class="fa-solid fa-plane mx-2 text-xs text-jp-text"></i><div class="h-[1px] w-full bg-jp-text"></div></div>
                                </div>
                            </transition>
                            <!-- Boarding Pass Cutout -->
                            <div class="absolute -left-2 top-1/2 w-4 h-4 bg-jp-bg rounded-full shadow-inner z-20"></div>
                            <div class="absolute -right-2 top-1/2 w-4 h-4 bg-jp-bg rounded-full shadow-inner z-20"></div>
                        </div>
                        <a href="https://guest-ui.west-qr.com/#/packages/login/index" target="_blank" class="mt-3 block bg-jp-surface border border-jp-blue/30 rounded-xl p-3 flex items-center justify-between shadow-sm hover:shadow-md transition active:scale-98 group">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-full bg-blue-500/10 text-jp-blue flex items-center justify-center"><i class="fa-solid fa-train-subway"></i></div>
                                <div><div class="text-xs text-jp-blue font-bold tracking-wider">JR WEST</div><div class="text-sm font-bold text-jp-text">Haruka 訂位 / 選位</div></div>
                            </div>
                            <i class="fa-solid fa-arrow-up-right-from-square text-jp-gray text-xs mr-1"></i>
                        </a>
                    </div>

                    <div v-if="currentDayEvents.length === 0" class="text-center py-12">
                        <div class="w-16 h-16 bg-jp-surface rounded-full flex items-center justify-center mx-auto mb-4 text-jp-gray/30 border border-jp-border"><i class="fa-solid fa-suitcase-rolling text-2xl"></i></div>
                        <p class="text-jp-gray text-sm font-light">開啟一段新的旅程</p>
                    </div>

                    <div v-for="(event, index) in currentDayEvents" :key="event.id" class="relative pl-6 group">
                        <div class="absolute left-[3px] top-3 bottom-[-24px] w-[1px] bg-jp-border group-last:bottom-2"></div>
                        <div class="absolute left-0 top-[10px] w-[7px] h-[7px] rounded-full ring-4 ring-jp-bg z-10 transition-colors duration-300" :class="getCategoryColor(event.category)"></div>
                        <div @click="editEvent(event)" class="bg-jp-surface p-5 rounded-2xl shadow-soft border border-jp-border active:scale-[0.99] transition-all duration-200 cursor-pointer relative overflow-hidden group/card">
                            <button @click.stop="triggerDeleteEvent(event)" class="absolute top-0 right-0 p-4 text-jp-gray hover:text-jp-red transition-colors z-20"><i class="fa-solid fa-trash-can"></i></button>
                            <div class="flex justify-between items-start relative z-10">
                                <div class="flex-1 pr-6">
                                    <div class="flex items-center gap-2 mb-1">
                                        <span class="text-sm font-medium text-jp-accent">{{ event.time }}</span>
                                        <div v-if="getEventWeather(event.time)" class="flex items-center gap-1 text-[10px] bg-jp-bg border border-jp-border px-2 py-0.5 rounded-full text-jp-gray">
                                            <i :class="getWeatherIcon(getEventWeather(event.time).code)"></i><span>{{ getEventWeather(event.time).temp }}°</span>
                                        </div>
                                    </div>
                                    <h3 class="text-lg font-medium text-jp-text tracking-wide mb-1">{{ event.title }}</h3>
                                    <p class="text-xs text-jp-gray flex items-center gap-1 cursor-pointer hover:text-jp-blue hover:underline transition-colors w-fit p-1 -ml-1 rounded active:bg-jp-bg/50" v-if="event.location" @click.stop="openGoogleMaps(event.location)">
                                        <i class="fa-solid fa-location-dot text-[10px]"></i> {{ event.location }} <i class="fa-solid fa-arrow-up-right-from-square text-[8px] opacity-60"></i>
                                    </p>

                                    <!-- Note / Link Display -->
                                    <div v-if="event.note" class="mt-1">
                                        <!-- Subtle Link Style -->
                                        <a v-if="isUrl(event.note)" :href="event.note" target="_blank" @click.stop class="inline-flex items-center gap-1.5 text-[10px] text-gray-400/80 hover:text-jp-accent transition mt-1 py-1">
                                            <i class="fa-solid fa-link"></i> Open Link
                                        </a>
                                        <p v-else class="text-xs text-jp-gray/80 bg-jp-bg p-2 rounded-lg mt-1 border border-jp-border">
                                            <i class="fa-regular fa-note-sticky mr-1"></i> {{ event.note }}
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div v-if="currentDayIndex === days.length - 1 && days[currentDayIndex].flight" class="mt-6 mb-4">
                         <div class="bg-jp-surface rounded-2xl shadow-sm border border-jp-border overflow-hidden relative group transition-all">
                            <div class="h-2 bg-jp-red w-full"></div>
                            <div @click="toggleFlight(currentDayIndex)" class="p-4 flex justify-between items-center cursor-pointer bg-jp-surface z-10 relative">
                                <div class="flex items-center gap-3">
                                    <div class="w-8 h-8 rounded-full bg-red-500/10 text-jp-red flex items-center justify-center"><i class="fa-solid fa-plane-departure text-sm"></i></div>
                                    <div><div class="text-xs font-bold text-jp-gray uppercase tracking-widest">Return Flight</div><div class="font-bold text-jp-text text-sm" v-if="!flightExpanded[currentDayIndex]">{{ days[currentDayIndex].flight.number || 'No Flight Info' }} <span v-if="days[currentDayIndex].flight.from" class="opacity-60 font-normal"> · {{ days[currentDayIndex].flight.from }} <i class="fa-solid fa-arrow-right text-[10px]"></i> {{ days[currentDayIndex].flight.to }}</span></div></div>
                                </div>
                                <i class="fa-solid text-jp-gray transition-transform duration-300" :class="flightExpanded[currentDayIndex] ? 'fa-chevron-up rotate-0' : 'fa-chevron-down'"></i>
                            </div>
                            <transition name="accordion">
                                <div v-if="flightExpanded[currentDayIndex]" class="px-5 pb-5 border-t border-jp-border">
                                    <div class="mt-4 mb-4"><label class="text-[9px] text-jp-gray block mb-1 uppercase tracking-wider">Flight No.</label><input v-model="days[currentDayIndex].flight.number" @input="autoFillFlight(currentDayIndex)" type="text" placeholder="e.g. CI157" class="w-full font-bold text-jp-text text-xl uppercase bg-transparent border-b border-jp-border focus:outline-none focus:border-jp-red transition placeholder-gray-400"></div>
                                    <div class="grid grid-cols-2 gap-6">
                                        <div><div class="flex items-end gap-2 mb-1"><span class="text-2xl font-bold text-jp-text">{{ days[currentDayIndex].flight.from || 'KIX' }}</span><span class="text-[9px] text-jp-gray mb-1">DEP</span></div><input type="date" v-model="days[currentDayIndex].date" class="w-full text-[10px] bg-transparent border-none p-0 text-jp-gray mb-1 focus:ring-0"><input type="time" v-model="days[currentDayIndex].flight.time" class="w-full text-lg font-bold bg-transparent border-none p-0 text-jp-text focus:ring-0"></div>
                                        <div class="text-right"><div class="flex items-end justify-end gap-2 mb-1"><span class="text-[9px] text-jp-gray mb-1">ARR</span><span class="text-2xl font-bold text-jp-text">{{ days[currentDayIndex].flight.to || 'TPE' }}</span></div><input type="date" v-model="days[currentDayIndex].flight.arrivalDate" class="w-full text-[10px] bg-transparent border-none p-0 text-jp-gray mb-1 text-right focus:ring-0"><input type="time" v-model="days[currentDayIndex].flight.arrivalTime" class="w-full text-lg font-bold bg-transparent border-none p-0 text-jp-text text-right focus:ring-0"></div>
                                    </div>
                                    <div class="mt-4 flex items-center justify-center opacity-20"><div class="h-[1px] w-full bg-jp-text"></div><i class="fa-solid fa-plane mx-2 text-xs text-jp-text transform rotate-180"></i><div class="h-[1px] w-full bg-jp-text"></div></div>
                                </div>
                            </transition>
                            <!-- Boarding Pass Cutout -->
                            <div class="absolute -left-2 top-1/2 w-4 h-4 bg-jp-bg rounded-full shadow-inner z-20"></div>
                            <div class="absolute -right-2 top-1/2 w-4 h-4 bg-jp-bg rounded-full shadow-inner z-20"></div>
                        </div>
                        <a href="https://guest-ui.west-qr.com/#/packages/login/index" target="_blank" class="mt-3 block bg-jp-surface border border-jp-red/30 rounded-xl p-3 flex items-center justify-between shadow-sm hover:shadow-md transition active:scale-98 group">
                            <div class="flex items-center gap-3">
                                <div class="w-8 h-8 rounded-full bg-red-500/10 text-jp-red flex items-center justify-center"><i class="fa-solid fa-train-subway"></i></div>
                                <div><div class="text-xs text-jp-red font-bold tracking-wider">JR WEST</div><div class="text-sm font-bold text-jp-text">Haruka 訂位 / 選位</div></div>
                            </div>
                            <i class="fa-solid fa-arrow-up-right-from-square text-jp-gray text-xs mr-1"></i>
                        </a>
                    </div>
                </div>
            </div>

            <!-- Tab 2: Expenses -->
            <div v-if="activeTab === 'expenses'" class="p-6 pb-28">
                <div class="bg-jp-text text-jp-bg rounded-2xl p-6 shadow-float mb-8 relative overflow-hidden">
                    <div class="absolute -right-6 -top-6 w-32 h-32 bg-white/5 rounded-full blur-2xl"></div>
                    <div class="flex justify-between items-start">
                        <div><p class="text-xs opacity-60 tracking-widest mb-2 uppercase">Total (TWD)</p><h2 class="text-4xl font-light tracking-tight mb-2">NT${{ totalExpense.toLocaleString() }}</h2></div>
                        <div class="text-right"><p class="text-[10px] opacity-40 uppercase">Rate</p><p class="text-sm font-mono opacity-80">{{ exchangeRate }}</p></div>
                    </div>
                    <div class="space-y-2 mt-4"><div v-for="t in travelers" :key="t" class="flex justify-between items-center text-xs opacity-80 border-b border-white/10 pb-1 last:border-0"><span>{{ t }}</span><span class="font-medium">${{ getPaidAmount(t).toLocaleString() }}</span></div></div>
                </div>
                <div v-if="debts.length > 0" class="mb-8">
                    <h3 class="text-xs font-bold text-jp-gray uppercase tracking-widest mb-3">Settlement (TWD)</h3>
                    <div class="bg-jp-surface rounded-xl p-1 shadow-sm border border-jp-border">
                        <div v-for="(debt, idx) in debts" :key="idx" class="p-3 flex items-center justify-between text-sm border-b border-jp-border last:border-0">
                            <div class="flex items-center gap-3"><span class="font-medium text-jp-text">{{ debt.from }}</span><i class="fa-solid fa-arrow-right-long text-jp-gray/50 text-xs"></i><span class="font-medium text-jp-text">{{ debt.to }}</span></div>
                            <span class="font-bold text-jp-red text-xs bg-jp-red/10 px-2 py-1 rounded">NT${{ Math.round(debt.amount).toLocaleString() }}</span>
                        </div>
                    </div>
                </div>
                <h3 class="text-xs font-bold text-jp-gray uppercase tracking-widest mb-3 flex justify-between items-center">History <button @click="triggerReset" class="hover:text-jp-red transition text-[10px] underline">Reset All</button></h3>
                <div class="space-y-3">
                    <div v-for="exp in sortedExpenses" :key="exp.id" class="bg-jp-surface px-4 py-3 rounded-xl border border-jp-border flex items-center justify-between hover:shadow-sm transition group">
                        <div class="flex items-center gap-3">
                            <div :class="getExpenseCategoryColor(exp.category)" class="w-10 h-10 rounded-full flex items-center justify-center flex-shrink-0 text-sm"><i :class="`fa-solid ${getExpenseCategoryIcon(exp.category)}`"></i></div>
                            <div><p class="font-medium text-jp-text text-sm">{{ exp.title }}</p><p class="text-[10px] text-jp-gray mt-0.5">{{ formatDateShort(exp.date) }} · <span class="bg-jp-bg border border-jp-border px-1 rounded">{{ exp.payer }}</span><span v-if="exp.originalCurrency === 'JPY'" class="ml-1 text-jp-blue">(¥{{ exp.originalAmount.toLocaleString() }})</span></p></div>
                        </div>
                        <div class="flex items-center gap-3"><span class="font-medium text-jp-text">NT${{ Math.round(exp.amount).toLocaleString() }}</span><button @click.stop="triggerDeleteExpense(exp.id)" class="text-jp-gray hover:text-jp-red p-2 transition-colors"><i class="fa-solid fa-trash-can text-xs"></i></button></div>
                    </div>
                </div>
            </div>

            <!-- Tab 3: Map -->
            <div v-if="activeTab === 'map'" class="h-full w-full flex flex-col overflow-hidden relative bg-gray-100">
                <div id="map-container" class="relative flex-none" :style="{ height: mapSplit + '%' }">
                    <div id="map" class="w-full h-full bg-gray-200"></div>
                    <button @click="locateUser" class="absolute bottom-4 right-4 z-[500] bg-jp-surface p-3 rounded-full shadow-lg text-jp-text hover:text-jp-blue active:scale-95 transition"><i class="fa-solid fa-crosshairs"></i></button>
                </div>
                <div class="flex-1 bg-jp-bg rounded-t-[2rem] -mt-6 relative z-[600] shadow-[0_-10px_40px_rgba(0,0,0,0.1)] flex flex-col overflow-hidden border-t border-jp-border">
                    <div class="w-full h-8 flex-none flex items-center justify-center cursor-ns-resize touch-none" @mousedown.prevent="startResize" @touchstart.prevent="startResize"><div class="w-12 h-1 bg-gray-300/50 rounded-full hover:bg-jp-accent transition-colors"></div></div>
                    <div class="px-6 pb-20 overflow-y-auto no-scrollbar flex-1">
                        <h3 class="text-sm font-bold text-jp-text uppercase tracking-widest mb-4 mt-2">Locations (Today)</h3>
                        <div class="space-y-3">
                             <div v-for="loc in mapLocations" :key="loc.id" class="flex items-center justify-between group p-2 hover:bg-jp-surface rounded-lg transition border border-transparent hover:border-jp-border">
                                <div class="flex items-center gap-4 overflow-hidden cursor-pointer" @click="flyToLocation(loc)">
                                    <div class="w-2 h-2 rounded-full bg-jp-accent flex-shrink-0"></div>
                                    <div class="overflow-hidden"><p class="font-medium text-sm text-jp-text truncate">{{ loc.location }}</p><p class="text-xs text-jp-gray">{{ loc.time }} · {{ loc.title }}</p></div>
                                </div>
                                <button @click="openGoogleMaps(loc.location)" class="w-8 h-8 rounded-full border border-jp-border flex items-center justify-center text-jp-gray hover:bg-jp-text hover:text-jp-bg transition flex-shrink-0"><i class="fa-solid fa-location-arrow text-xs"></i></button>
                            </div>
                            <div v-if="mapLocations.length === 0" class="text-center text-jp-gray text-xs mt-8">No locations with coordinates found.</div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- FAB -->
        <button v-if="activeTab !== 'map'" @click="openAddModal" class="absolute bottom-24 right-6 w-14 h-14 bg-jp-text text-jp-bg rounded-full shadow-float flex items-center justify-center text-xl transition-transform hover:scale-105 active:scale-95 z-30"><i class="fa-solid fa-plus not-italic"></i></button>

        <!-- Bottom Nav (Updated Style) -->
        <nav class="absolute bottom-0 w-full h-20 bg-jp-surface border-t border-jp-border flex justify-around items-start pt-4 z-[800]">
            <button @click="activeTab = 'itinerary'" :class="activeTab === 'itinerary' ? 'text-jp-text' : 'text-gray-300'" class="flex flex-col items-center w-16 transition-colors duration-300 group">
                <i class="fa-solid fa-calendar-days text-lg mb-1"></i>
                <span class="text-[9px] tracking-wider uppercase font-medium">Plan</span>
            </button>
            <button @click="activeTab = 'expenses'" :class="activeTab === 'expenses' ? 'text-jp-text' : 'text-gray-300'" class="flex flex-col items-center w-16 transition-colors duration-300 group">
                <i class="fa-solid fa-wallet text-lg mb-1"></i>
                <span class="text-[9px] tracking-wider uppercase font-medium">Wallet</span>
            </button>
            <button @click="activeTab = 'map'" :class="activeTab === 'map' ? 'text-jp-text' : 'text-gray-300'" class="flex flex-col items-center w-16 transition-colors duration-300 group">
                <i class="fa-solid fa-map text-lg mb-1"></i>
                <span class="text-[9px] tracking-wider uppercase font-medium">Map</span>
            </button>
        </nav>

        <!-- Modals -->
        <transition name="fade">
            <div v-if="confirmState.show" class="absolute inset-0 z-[2000] bg-black/60 backdrop-blur-[2px] flex items-center justify-center p-4">
                <div class="bg-jp-surface rounded-2xl p-6 shadow-2xl w-full max-w-xs text-center border border-jp-border">
                    <p class="font-bold text-jp-text text-lg mb-6">{{ confirmState.message }}</p>
                    <div class="flex gap-3">
                        <button @click="confirmState.show = false" class="flex-1 py-3 rounded-xl bg-jp-bg border border-jp-border text-jp-gray font-bold active:scale-95 transition">Cancel</button>
                        <button @click="executeConfirm" class="flex-1 py-3 rounded-xl bg-jp-red text-white font-bold shadow-lg active:scale-95 transition">Confirm</button>
                    </div>
                </div>
            </div>
        </transition>

        <transition name="slide-up">
            <div v-if="showEventModal" class="absolute inset-0 z-[1000] bg-jp-bg flex flex-col">
                <div class="px-6 py-4 border-b border-jp-border flex justify-center items-center bg-jp-surface/50 backdrop-blur-sm relative flex-none">
                    <h3 class="font-bold text-jp-text text-lg">{{ isEditing ? 'Edit Event' : 'New Event' }}</h3>
                </div>
                <div class="p-8 space-y-8 flex-1 overflow-y-auto">
                    <div class="space-y-6">
                        <div class="border-b border-jp-border pb-2"><label class="text-[10px] uppercase tracking-widest text-jp-gray block mb-1">Title</label><input v-model="eventForm.title" type="text" class="w-full text-xl bg-transparent focus:outline-none text-jp-text placeholder-jp-gray/30" placeholder="Where to go?"></div>
                        <div class="flex gap-6">
                            <div class="flex-1 border-b border-jp-border pb-2"><label class="text-[10px] uppercase tracking-widest text-jp-gray block mb-1">Time</label><input v-model="eventForm.time" type="time" class="w-full bg-transparent focus:outline-none text-jp-text"></div>
                            <div class="flex-1 border-b border-jp-border pb-2"><label class="text-[10px] uppercase tracking-widest text-jp-gray block mb-1">Category</label><select v-model="eventForm.category" class="w-full bg-transparent focus:outline-none text-jp-text"><option value="sightseeing">Sightseeing</option><option value="food">Food</option><option value="transport">Transport</option><option value="shopping">Shopping</option></select></div>
                        </div>
                        <div class="border-b border-jp-border pb-2"><label class="text-[10px] uppercase tracking-widest text-jp-gray block mb-1">Location</label><input v-model="eventForm.location" type="text" class="w-full bg-transparent focus:outline-none text-jp-text placeholder-jp-gray/30" placeholder="Place name..."></div>
                        <div class="border-b border-jp-border pb-2"><label class="text-[10px] uppercase tracking-widest text-jp-gray block mb-1">Note / Ticket Link</label><input v-model="eventForm.note" type="text" class="w-full bg-transparent focus:outline-none text-jp-text placeholder-jp-gray/30" placeholder="https://... or Memo"></div>
                    </div>
                </div>
                <div class="p-6 border-t border-jp-border bg-jp-surface flex gap-4 flex-none pb-safe">
                    <button @click="closeEventModal" class="flex-1 py-3 rounded-xl bg-jp-bg border border-jp-border text-jp-gray font-bold hover:bg-jp-border transition">Cancel</button>
                    <button @click="saveEvent" class="flex-1 py-3 rounded-xl bg-jp-text text-jp-bg font-bold shadow-lg hover:opacity-90 transition">Save</button>
                </div>
            </div>
        </transition>

        <transition name="slide-up">
            <div v-if="showExpenseModal" class="absolute inset-0 z-[1000] bg-jp-bg flex flex-col">
                <div class="px-6 py-4 border-b border-jp-border flex justify-center items-center bg-jp-surface/50 backdrop-blur-sm relative flex-none">
                    <h3 class="font-bold text-jp-text text-lg">Add Expense</h3>
                </div>
                <div class="p-8 space-y-8 flex-1 overflow-y-auto">
                    <div class="flex justify-center mb-2">
                        <div class="bg-jp-border p-1 rounded-full flex text-xs font-bold">
                            <button @click="expenseCurrency = 'TWD'" :class="expenseCurrency === 'TWD' ? 'bg-jp-surface text-jp-text shadow-sm' : 'text-jp-gray'" class="px-4 py-1.5 rounded-full transition-all">TWD (NT$)</button>
                            <button @click="expenseCurrency = 'JPY'" :class="expenseCurrency === 'JPY' ? 'bg-jp-surface text-jp-text shadow-sm' : 'text-jp-gray'" class="px-4 py-1.5 rounded-full transition-all">JPY (¥)</button>
                        </div>
                    </div>
                    <div class="text-center pb-6">
                        <label class="text-[10px] uppercase tracking-widest text-jp-gray block mb-2">Amount ({{ expenseCurrency }})</label>
                        <div class="flex justify-center items-center">
                            <span class="text-2xl text-jp-text mr-1">{{ expenseCurrency === 'JPY' ? '¥' : 'NT$' }}</span>
                            <input v-model.number="expenseForm.amount" type="number" class="text-5xl font-light text-center w-48 bg-transparent focus:outline-none text-jp-text placeholder-jp-gray/30" placeholder="0" autofocus>
                        </div>
                        <div v-if="expenseCurrency === 'JPY' && expenseForm.amount" class="text-sm text-jp-accent font-medium mt-2">≈ NT$ {{ Math.round(expenseForm.amount * exchangeRate).toLocaleString() }}</div>
                    </div>
                    <div>
                        <label class="text-[10px] uppercase tracking-widest text-jp-gray block mb-3">Category</label>
                        <div class="grid grid-cols-3 gap-3">
                            <button v-for="cat in expenseCategories" :key="cat.id" @click="expenseForm.category = cat.id" :class="expenseForm.category === cat.id ? cat.color + ' ring-2 ring-offset-1 ring-jp-border' : 'bg-jp-surface text-jp-gray border border-jp-border'" class="flex flex-col items-center justify-center p-3 rounded-xl transition-all">
                                <i :class="`fa-solid ${cat.icon} text-lg mb-1`"></i><span class="text-xs font-medium">{{ cat.label }}</span>
                            </button>
                        </div>
                    </div>
                    <div class="border-b border-jp-border pb-2"><label class="text-[10px] uppercase tracking-widest text-jp-gray block mb-1">For What?</label><input v-model="expenseForm.title" type="text" class="w-full text-lg bg-transparent focus:outline-none text-jp-text placeholder-jp-gray/30" placeholder="e.g. Dinner"></div>
                    <div>
                        <label class="text-[10px] uppercase tracking-widest text-jp-gray block mb-3">Who Paid?</label>
                        <div class="flex flex-wrap gap-3">
                            <button v-for="person in travelers" :key="person" @click="expenseForm.payer = person" :class="expenseForm.payer === person ? 'bg-jp-text text-jp-bg shadow-lg' : 'bg-jp-surface text-jp-gray border border-jp-border'" class="px-5 py-2 rounded-full text-sm transition-all">{{ person }}</button>
                        </div>
                    </div>
                </div>
                <div class="p-6 border-t border-jp-border bg-jp-surface flex gap-4 flex-none pb-safe">
                    <button @click="showExpenseModal = false" class="flex-1 py-3 rounded-xl bg-jp-bg border border-jp-border text-jp-gray font-bold hover:bg-jp-border transition">Cancel</button>
                    <button @click="saveExpense" class="flex-1 py-3 rounded-xl bg-jp-text text-jp-bg font-bold shadow-lg hover:opacity-90 transition">Add</button>
                </div>
            </div>
        </transition>
        
        <transition name="fade">
            <div v-if="showSettings" class="absolute inset-0 z-[1000] bg-black/60 backdrop-blur-sm flex items-center justify-center p-6">
                <div class="bg-jp-surface w-full max-w-sm rounded-2xl p-6 shadow-2xl border border-jp-border">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="font-medium text-lg text-jp-text">Settings</h3>
                        <button @click="showSettings = false" class="w-8 h-8 rounded-full bg-jp-bg flex items-center justify-center text-jp-gray"><i class="fa-solid fa-xmark"></i></button>
                    </div>
                    
                    <div class="mb-6">
                        <label class="text-[10px] uppercase tracking-widest text-jp-gray block mb-2">Theme Style</label>
                        <div class="grid grid-cols-3 gap-2">
                            <button @click="changeTheme('default')" :class="theme === 'default' ? 'ring-2 ring-jp-text' : 'border border-jp-border'" class="bg-[#FDFBF7] h-12 rounded-lg relative overflow-hidden group">
                                <span class="text-[10px] font-bold text-[#433D3C] relative z-10">Matcha</span>
                                <div class="absolute bottom-0 w-full h-1 bg-[#8E9F86]"></div>
                            </button>
                            <button @click="changeTheme('dark')" :class="theme === 'dark' ? 'ring-2 ring-blue-400' : 'border border-jp-border'" class="bg-[#18181b] h-12 rounded-lg relative overflow-hidden">
                                <span class="text-[10px] font-bold text-white relative z-10">Gion Night</span>
                                <div class="absolute bottom-0 w-full h-1 bg-[#fbbf24]"></div>
                            </button>
                            <button @click="changeTheme('sakura')" :class="theme === 'sakura' ? 'ring-2 ring-pink-400' : 'border border-jp-border'" class="bg-[#fff1f2] h-12 rounded-lg relative overflow-hidden">
                                <span class="text-[10px] font-bold text-[#881337] relative z-10">Sakura</span>
                                <div class="absolute bottom-0 w-full h-1 bg-[#fb7185]"></div>
                            </button>
                        </div>
                    </div>

                    <div class="mb-6">
                        <label class="text-[10px] uppercase tracking-widest text-jp-gray block mb-2">Exchange Rate (JPY → TWD)</label>
                        <div class="flex items-center bg-jp-bg rounded-lg px-4 py-2 border border-jp-border">
                            <span class="text-jp-gray text-sm mr-2">1 JPY =</span>
                            <input v-model.number="exchangeRate" type="number" step="0.001" class="flex-1 bg-transparent focus:outline-none font-mono text-jp-text">
                            <span class="text-jp-gray text-sm ml-2">TWD</span>
                        </div>
                    </div>

                    <div class="space-y-3 mb-6">
                         <label class="text-[10px] uppercase tracking-widest text-jp-gray block">Travelers</label>
                        <div v-for="(person, idx) in travelers" :key="idx" class="flex gap-3">
                            <input v-model="travelers[idx]" class="flex-1 bg-jp-bg border border-jp-border rounded-lg px-4 py-3 text-sm focus:outline-none focus:ring-1 focus:ring-jp-accent transition text-jp-text">
                            <button @click="removeTraveler(idx)" v-if="travelers.length > 1" class="text-jp-gray hover:text-jp-red px-2"><i class="fa-solid fa-minus"></i></button>
                        </div>
                    </div>
                    <button @click="addTraveler" class="w-full py-3 border border-dashed border-jp-gray/30 rounded-xl text-jp-gray text-sm hover:border-jp-accent hover:text-jp-accent transition mb-6">Add New Traveler</button>
                    <div class="text-center"><button @click="triggerReset" class="text-xs text-jp-gray/50 hover:text-jp-red transition">Reset App Data</button></div>
                </div>
            </div>
        </transition>

    </div>

    <script type="module">
        // --- FIREBASE SETTINGS (UPDATED: 2025-12-06) ---
        const firebaseConfig = {
            apiKey: "AIzaSyCPQtJFQ6qSb5oUNo_Zk7UQbilkj6_jvos",
            authDomain: "kyoto-trip-free.firebaseapp.com",
            projectId: "kyoto-trip-free",
            storageBucket: "kyoto-trip-free.firebasestorage.app",
            messagingSenderId: "118179262238",
            appId: "1:118179262238:web:57bb92b1252f1ec1cba30f",
            measurementId: "G-ZWHRZP1DKS"
        };

        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, collection } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        const { createApp, ref, computed, onMounted, watch, nextTick } = Vue;

        createApp({
            setup() {
                const app = initializeApp(firebaseConfig);
                const auth = getAuth(app);
                const db = getFirestore(app);
                const isOnline = ref(false);
                const isSyncing = ref(false);
                const remoteUpdateLock = ref(false);
                const errorMessage = ref('');

                const getFixedDate = (offset = 0) => { const d = new Date('2025-12-11'); d.setDate(d.getDate() + offset); return d.toISOString().split('T')[0]; };
                const activeTab = ref('itinerary');
                const showEventModal = ref(false);
                const showExpenseModal = ref(false);
                const showSettings = ref(false);
                const currentDayIndex = ref(0);
                const isEditing = ref(false);
                const confirmState = ref({ show: false, message: '', onConfirm: null });
                const mapSplit = ref(60); 
                const isResizing = ref(false);
                const flightExpanded = ref({ 0: false });
                const exchangeRate = ref(0.22);
                const expenseCurrency = ref('JPY'); 
                const theme = ref('default');
                const weatherData = ref(null);
                const mapInstance = ref(null);
                const markersLayer = ref(null); // Changed: Use LayerGroup for better management
                const userMarker = ref(null);

                const defaultTravelers = ['Me', 'You'];
                const defaultDays = [ { date: getFixedDate(0), flight: { number: '', time: '', from: 'TPE', to: 'KIX', arrivalDate: getFixedDate(0), arrivalTime: '' }, events: [ { id: 1, time: '14:00', title: 'Check-in Hotel', location: 'Kyoto Station', lat: 34.9858, lng: 135.7588, category: 'transport', note: '' }, { id: 2, time: '16:00', title: '清水寺 Kiyomizu-dera', location: 'Kiyomizu-dera', lat: 34.994856, lng: 135.785046, category: 'sightseeing', note: 'https://www.kiyomizudera.or.jp/en/' } ] }, { date: getFixedDate(1), flight: { number: '', time: '', from: '', to: '', arrivalDate: getFixedDate(1), arrivalTime: '' }, events: [ { id: 4, time: '10:00', title: '嵐山竹林', location: 'Arashiyama Bamboo Grove', lat: 35.017, lng: 135.670, category: 'sightseeing', note: '' }, { id: 5, time: '19:00', title: '燒肉弘', location: 'Yakiniku Hiro', lat: 35.006, lng: 135.770, category: 'food', note: 'Booked via TableCheck' } ] } ];
                
                // --- CRITICAL DATA REPAIR FUNCTION ---
                // Ensures older data structures (missing flight info) don't crash the UI
                const ensureValidData = (dataDays) => {
                    if (!Array.isArray(dataDays) || dataDays.length === 0) return defaultDays;
                    return dataDays.map(day => ({
                        ...day,
                        date: day.date || new Date().toISOString().split('T')[0],
                        flight: day.flight || { number: '', time: '', from: '', to: '', arrivalDate: day.date, arrivalTime: '' },
                        events: Array.isArray(day.events) ? day.events : []
                    }));
                };

                const travelers = ref(JSON.parse(localStorage.getItem('jp_travelers_v3')) || defaultTravelers);
                // Apply repair on load
                const days = ref(ensureValidData(JSON.parse(localStorage.getItem('jp_days_v3'))));
                const expenses = ref(JSON.parse(localStorage.getItem('jp_expenses_v3')) || []);

                const eventForm = ref({ id: null, title: '', time: '', location: '', lat: null, lng: null, category: 'sightseeing', note: '' });
                const expenseForm = ref({ id: null, amount: '', title: '', payer: travelers.value[0], date: '', category: 'food' });

                const flightDB = { 'JX820': { from: 'TPE', to: 'KIX', dep: '08:30', arr: '11:50' }, 'JX821': { from: 'KIX', to: 'TPE', dep: '12:50', arr: '15:15' }, 'CI156': { from: 'TPE', to: 'KIX', dep: '08:10', arr: '11:40' }, 'CI157': { from: 'KIX', to: 'TPE', dep: '12:50', arr: '15:20' }, 'CI172': { from: 'TPE', to: 'KIX', dep: '14:20', arr: '17:50' }, 'CI173': { from: 'KIX', to: 'TPE', dep: '19:05', arr: '21:35' }, 'BR132': { from: 'TPE', to: 'KIX', dep: '08:30', arr: '11:55' }, 'BR131': { from: 'KIX', to: 'TPE', dep: '13:10', arr: '15:35' }, 'BR130': { from: 'TPE', to: 'KIX', dep: '12:30', arr: '16:00' }, 'BR129': { from: 'KIX', to: 'TPE', dep: '18:30', arr: '20:50' }, 'IT210': { from: 'TPE', to: 'KIX', dep: '07:00', arr: '10:25' }, 'IT211': { from: 'KIX', to: 'TPE', dep: '11:15', arr: '13:30' }, 'JL816': { from: 'TPE', to: 'KIX', dep: '12:15', arr: '15:45' }, 'JL813': { from: 'KIX', to: 'TPE', dep: '09:10', arr: '11:30' } };
                const expenseCategories = [ { id: 'food', label: 'Food', icon: 'fa-utensils', color: 'bg-orange-100 text-orange-500' }, { id: 'transport', label: 'Transport', icon: 'fa-train-subway', color: 'bg-blue-100 text-blue-500' }, { id: 'shopping', label: 'Shopping', icon: 'fa-bag-shopping', color: 'bg-purple-100 text-purple-500' }, { id: 'sightseeing', label: 'Sightseeing', icon: 'fa-camera', color: 'bg-red-100 text-red-500' }, { id: 'stay', label: 'Stay', icon: 'fa-bed', color: 'bg-indigo-100 text-indigo-500' }, { id: 'other', label: 'Other', icon: 'fa-receipt', color: 'bg-gray-100 text-gray-500' } ];

                const tripDocRef = doc(db, 'trips', 'shared_trip_randall_final_v2');

                const initSync = async () => {
                    try {
                        await signInAnonymously(auth);
                        isOnline.value = true;
                        onSnapshot(tripDocRef, (docSnap) => {
                            if (docSnap.exists()) {
                                remoteUpdateLock.value = true;
                                const data = docSnap.data();
                                travelers.value = data.travelers || defaultTravelers;
                                // Apply repair on sync
                                days.value = ensureValidData(data.days);
                                expenses.value = data.expenses || [];
                                exchangeRate.value = data.exchangeRate || 0.22;
                                theme.value = data.theme || 'default';
                                applyTheme(theme.value);
                                nextTick(() => { 
                                    remoteUpdateLock.value = false; 
                                    if(activeTab.value === 'map') updateMapMarkers();
                                });
                            } else {
                                saveToFirebase();
                            }
                        }, (error) => {
                            console.error("Sync Error:", error);
                            if (error.code === 'permission-denied') {
                                errorMessage.value = 'Permission Denied: Check Firestore Rules.';
                            } else {
                                errorMessage.value = 'Sync Error: ' + error.message;
                            }
                            isOnline.value = false;
                        });
                    } catch (error) {
                        console.error("Auth Error:", error);
                        errorMessage.value = 'Auth Failed: ' + error.message;
                    }
                };

                const saveToFirebase = async () => {
                    if (remoteUpdateLock.value) return;
                    if (!auth.currentUser) return;
                    isSyncing.value = true;
                    try {
                        await setDoc(tripDocRef, {
                            travelers: travelers.value,
                            days: days.value,
                            expenses: expenses.value,
                            exchangeRate: exchangeRate.value,
                            theme: theme.value,
                            lastUpdated: new Date()
                        }, { merge: true });
                        errorMessage.value = ''; 
                    } catch (e) {
                        console.error("Save failed", e);
                         if (e.code === 'permission-denied') {
                            errorMessage.value = 'Save Failed: Permission Denied.';
                        }
                    } finally {
                        setTimeout(() => isSyncing.value = false, 500);
                    }
                };
                
                // Watch for days changes to prevent index out of bounds
                watch(days, (newDays) => {
                    if (currentDayIndex.value >= newDays.length) {
                        currentDayIndex.value = 0;
                    }
                    saveToFirebase();
                }, { deep: true });

                watch([travelers, expenses, exchangeRate, theme], () => {
                    saveToFirebase();
                }, { deep: true });

                const applyTheme = (t) => {
                    if (t === 'default') document.documentElement.removeAttribute('data-theme');
                    else document.documentElement.setAttribute('data-theme', t);
                    if (mapInstance.value && activeTab.value === 'map') initMap(true);
                };
                const changeTheme = (t) => theme.value = t;

                const getExpenseCategoryIcon = (catId) => { const cat = expenseCategories.find(c => c.id === catId); return cat ? cat.icon : 'fa-receipt'; };
                const getExpenseCategoryColor = (catId) => { const cat = expenseCategories.find(c => c.id === catId); return cat ? cat.color : 'bg-gray-100 text-gray-500'; };
                const toggleFlight = (index) => { flightExpanded.value[index] = !flightExpanded.value[index]; };
                const autoFillFlight = (dayIndex) => {
                    const day = days.value[dayIndex];
                    if(!day.flight || !day.flight.number) return;
                    const num = day.flight.number.toUpperCase().replace(/\s/g, '');
                    if (flightDB[num]) { day.flight.from = flightDB[num].from; day.flight.to = flightDB[num].to; if (!day.flight.time) day.flight.time = flightDB[num].dep; if (!day.flight.arrivalTime) day.flight.arrivalTime = flightDB[num].arr; day.flight.arrivalDate = day.date; } 
                    else { if (dayIndex === 0) { if(!day.flight.from) day.flight.from = 'TPE'; if(!day.flight.to) day.flight.to = 'KIX'; } else if (dayIndex === days.value.length - 1) { if(!day.flight.from) day.flight.from = 'KIX'; if(!day.flight.to) day.flight.to = 'TPE'; } }
                };
                const isUrl = (str) => { if (!str) return false; const pattern = new RegExp('^(https?:\\/\\/)?' + '((([a-z\\d]([a-z\\d-]*[a-z\\d])*)\\.)+[a-z]{2,}|' + '((\\d{1,3}\\.){3}\\d{1,3}))' + '(\\:\\d+)?(\\/[-a-z\\d%_.~+]*)*' + '(\\?[;&a-z\\d%_.~+=-]*)?' + '(\\#[-a-z\\d_]*)?$', 'i'); return !!pattern.test(str); };
                const startResize = (e) => { isResizing.value = true; window.addEventListener('mousemove', onResize); window.addEventListener('touchmove', onResize, { passive: false }); window.addEventListener('mouseup', stopResize); window.addEventListener('touchend', stopResize); };
                const onResize = (e) => { const clientY = e.touches ? e.touches[0].clientY : e.clientY; const containerHeight = window.innerHeight; let percentage = (clientY / containerHeight) * 100; if (percentage < 20) percentage = 20; if (percentage > 85) percentage = 85; mapSplit.value = percentage; if(mapInstance.value) mapInstance.value.invalidateSize(); };
                const stopResize = () => { isResizing.value = false; window.removeEventListener('mousemove', onResize); window.removeEventListener('touchmove', onResize); window.removeEventListener('mouseup', stopResize); window.removeEventListener('touchend', stopResize); if(mapInstance.value) mapInstance.value.invalidateSize(); };
                const fetchWeather = async () => { try { const lat = 35.0116, lon = 135.7681; const response = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&hourly=temperature_2m,weathercode&current_weather=true&timezone=Asia%2FTokyo&forecast_days=14`); const data = await response.json(); weatherData.value = data; } catch (e) { console.error("Weather fetch failed", e); } };
                
                // --- FIXED: Map Initialization Logic ---
                const initMap = async () => {
                    await nextTick();
                    const container = document.getElementById('map');
                    if (!container) return;

                    // Always destroy the old map instance because v-if destroys the DOM element
                    if (mapInstance.value) { 
                        mapInstance.value.remove();
                        mapInstance.value = null;
                    }

                    // Create new map
                    mapInstance.value = L.map('map').setView([35.0116, 135.7681], 13);
                    
                    let tileUrl = theme.value === 'dark' ? 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png' : 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png';
                    L.tileLayer(tileUrl, { attribution: '&copy; OpenStreetMap &copy; CARTO', subdomains: 'abcd', maxZoom: 20 }).addTo(mapInstance.value);
                    
                    // Create a layer group to handle markers (easy clearing)
                    markersLayer.value = L.layerGroup().addTo(mapInstance.value);

                    updateMapMarkers();
                };

                const updateMapMarkers = () => {
                    if (!mapInstance.value || !markersLayer.value) return;
                    
                    // Clear old markers first
                    markersLayer.value.clearLayers();
                    
                    const events = currentDayEvents.value;
                    const group = L.featureGroup(); // Used only for calculating bounds

                    events.forEach(e => {
                        if (e.lat && e.lng) {
                            const pinBg = theme.value === 'dark' ? '#fbbf24' : '#433D3C';
                            const pinText = theme.value === 'dark' ? '#000' : '#fff';
                            const iconHtml = `<div style="background-color: ${pinBg}; width: 24px; height: 24px; border-radius: 50%; border: 2px solid white; display: flex; align-items: center; justify-content: center; color: ${pinText}; font-size: 10px; font-weight: bold; box-shadow: 0 2px 5px rgba(0,0,0,0.3); cursor: pointer;">${e.id}</div>`;
                            const customIcon = L.divIcon({ className: 'custom-pin', html: iconHtml, iconSize: [24, 24], iconAnchor: [12, 12] });
                            
                            const marker = L.marker([e.lat, e.lng], { icon: customIcon });
                            marker.on('click', () => { window.open(`https://www.google.com/maps/search/?api=1&query=${e.lat},${e.lng}`, '_blank'); });
                            
                            // Add to the LayerGroup (for display) and FeatureGroup (for bounds)
                            markersLayer.value.addLayer(marker);
                            group.addLayer(marker);
                        }
                    });

                    // Fit bounds if there are markers
                    if (events.filter(e => e.lat).length > 0) {
                        mapInstance.value.fitBounds(group.getBounds().pad(0.1));
                    }
                };
                
                // Watchers
                watch(activeTab, (newTab) => { 
                    if (newTab === 'map') {
                        // Small timeout to ensure transition animation allows DOM to paint
                        setTimeout(() => { 
                            initMap(); 
                            if(mapInstance.value) mapInstance.value.invalidateSize(); 
                        }, 100); 
                    }
                });
                
                watch(currentDayIndex, () => { 
                    if (activeTab.value === 'map') updateMapMarkers(); 
                });

                const locateUser = () => { if (!navigator.geolocation) return alert("Geolocation not supported"); navigator.geolocation.getCurrentPosition((pos) => { const lat = pos.coords.latitude, lng = pos.coords.longitude; if (userMarker.value) mapInstance.value.removeLayer(userMarker.value); const pulseIcon = L.divIcon({ className: 'user-location-marker', iconSize: [20, 20] }); userMarker.value = L.marker([lat, lng], { icon: pulseIcon }).addTo(mapInstance.value); mapInstance.value.flyTo([lat, lng], 15); }, () => { alert("Unable to retrieve location"); }); };
                const flyToLocation = (loc) => { if (mapInstance.value && loc.lat && loc.lng) mapInstance.value.flyTo([loc.lat, loc.lng], 16); };
                const openGoogleMaps = (locationName) => { window.open(`https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(locationName + ' 京都')}`, '_blank'); };
                const geocodeLocation = async (query) => { try { const res = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query + ' Kyoto')}`); const data = await res.json(); if (data && data.length > 0) return { lat: parseFloat(data[0].lat), lng: parseFloat(data[0].lon) }; } catch (e) { console.error("Geocode failed"); } return null; };
                const getEventWeather = (timeStr) => { if (!weatherData.value || !timeStr) return null; const currentDayDate = days.value[currentDayIndex.value].date; const times = weatherData.value.hourly.time; const index = times.findIndex(t => t.startsWith(currentDayDate) && t.includes(timeStr.split(':')[0] + ':00')); if (index !== -1) return { temp: weatherData.value.hourly.temperature_2m[index], code: weatherData.value.hourly.weathercode[index] }; return null; };
                const currentKyotoWeather = computed(() => { if(!weatherData.value || !weatherData.value.current_weather) return null; return { temperature: weatherData.value.current_weather.temperature, weathercode: weatherData.value.current_weather.weathercode } });
                const getWeatherIcon = (code) => { if (code === 0) return 'fa-solid fa-sun text-orange-400'; if (code >= 1 && code <= 3) return 'fa-solid fa-cloud-sun text-yellow-500'; if (code >= 45) return 'fa-solid fa-smog text-gray-400'; if (code >= 51 && code <= 67) return 'fa-solid fa-cloud-rain text-blue-400'; if (code >= 80) return 'fa-solid fa-cloud-showers-heavy text-blue-500'; return 'fa-solid fa-cloud text-gray-400'; };
                const currentDayEvents = computed(() => { const day = days.value[currentDayIndex.value]; return day ? day.events.sort((a, b) => a.time.localeCompare(b.time)) : []; });
                const sortedExpenses = computed(() => [...expenses.value].sort((a, b) => new Date(b.date) - new Date(a.date)));
                const totalExpense = computed(() => expenses.value.reduce((sum, item) => sum + item.amount, 0));
                const mapLocations = computed(() => currentDayEvents.value.filter(e => e.location));
                const getTabTitle = computed(() => { if (activeTab.value === 'itinerary') return 'Kyoto Plan'; if (activeTab.value === 'expenses') return 'Expenses'; return 'Navigation'; });
                const debts = computed(() => { if (travelers.value.length === 0) return []; const balances = {}; travelers.value.forEach(p => balances[p] = 0); const total = totalExpense.value; const perPerson = total / travelers.value.length; expenses.value.forEach(exp => { if (balances[exp.payer] !== undefined) balances[exp.payer] += exp.amount; }); travelers.value.forEach(p => balances[p] -= perPerson); let debtors = [], creditors = []; for (const [person, amount] of Object.entries(balances)) { if (amount < -1) debtors.push({ person, amount }); if (amount > 1) creditors.push({ person, amount }); } debtors.sort((a, b) => a.amount - b.amount); creditors.sort((a, b) => b.amount - a.amount); const transactions = []; let i = 0, j = 0; while (i < debtors.length && j < creditors.length) { const debtor = debtors[i]; const creditor = creditors[j]; const amount = Math.min(Math.abs(debtor.amount), creditor.amount); transactions.push({ from: debtor.person, to: creditor.person, amount: amount }); debtor.amount += amount; creditor.amount -= amount; if (Math.abs(debtor.amount) < 1) i++; if (creditor.amount < 1) j++; } return transactions; });
                const getDayName = (dateStr) => new Date(dateStr).toLocaleDateString('en-US', { weekday: 'short' });
                const formatDateShort = (dateStr) => { const d = new Date(dateStr); return `${d.getMonth() + 1}/${d.getDate()}`; };
                const getCategoryColor = (cat) => ({ sightseeing: 'bg-jp-red', food: 'bg-yellow-600', transport: 'bg-jp-blue', shopping: 'bg-purple-400' }[cat] || 'bg-gray-400');
                const getCategoryIcon = (cat) => `fa-solid ` + ({ sightseeing: 'fa-torii-gate', food: 'fa-bowl-rice', transport: 'fa-train-subway', shopping: 'fa-bag-shopping' }[cat] || 'fa-star');
                const getPaidAmount = (person) => expenses.value.filter(e => e.payer === person).reduce((sum, e) => sum + e.amount, 0);
                const addDay = () => { const lastDate = new Date(days.value[days.value.length - 1].date); lastDate.setDate(lastDate.getDate() + 1); days.value.push({ date: lastDate.toISOString().split('T')[0], flight: { number: '', time: '', from: '', to: '', arrivalDate: lastDate.toISOString().split('T')[0], arrivalTime: '' }, events: [] }); currentDayIndex.value = days.value.length - 1; };
                const openAddModal = () => { if (activeTab.value === 'itinerary') { isEditing.value = false; eventForm.value = { id: Date.now(), title: '', time: '09:00', location: '', lat: null, lng: null, category: 'sightseeing', note: '' }; showEventModal.value = true; } else if (activeTab.value === 'expenses') { expenseForm.value = { id: Date.now(), amount: '', title: '', payer: travelers.value[0], date: new Date().toISOString(), category: 'food' }; showExpenseModal.value = true; } };
                const editEvent = (event) => { isEditing.value = true; eventForm.value = { ...event }; showEventModal.value = true; };
                const saveEvent = async () => { if (!eventForm.value.title) return; if (eventForm.value.location && (!eventForm.value.lat)) { const coords = await geocodeLocation(eventForm.value.location); if (coords) { eventForm.value.lat = coords.lat; eventForm.value.lng = coords.lng; } } const day = days.value[currentDayIndex.value]; if (isEditing.value) { const idx = day.events.findIndex(e => e.id === eventForm.value.id); if (idx !== -1) day.events[idx] = { ...eventForm.value }; } else { day.events.push({ ...eventForm.value }); } closeEventModal(); if(activeTab.value === 'map') updateMapMarkers(); };
                const deleteEvent = () => { const day = days.value[currentDayIndex.value]; day.events = day.events.filter(e => e.id !== eventForm.value.id); closeEventModal(); if(activeTab.value === 'map') updateMapMarkers(); };
                const executeConfirm = () => { if (confirmState.value.onConfirm) { confirmState.value.onConfirm(); } confirmState.value.show = false; };
                const showConfirm = (message, onConfirm) => { confirmState.value.message = message; confirmState.value.onConfirm = onConfirm; confirmState.value.show = true; };
                const triggerDeleteEvent = (event) => { showConfirm('Delete this event?', () => { const day = days.value[currentDayIndex.value]; day.events = day.events.filter(e => e.id !== event.id); if(activeTab.value === 'map') updateMapMarkers(); }); };
                const closeEventModal = () => showEventModal.value = false;
                const saveExpense = () => { if (!expenseForm.value.amount || !expenseForm.value.title) return; let finalAmount = expenseForm.value.amount; let originalAmount = null; let originalCurrency = 'TWD'; if (expenseCurrency.value === 'JPY') { originalAmount = expenseForm.value.amount; originalCurrency = 'JPY'; finalAmount = expenseForm.value.amount * exchangeRate.value; } expenses.value.push({ ...expenseForm.value, amount: finalAmount, originalAmount: originalAmount, originalCurrency: originalCurrency, date: new Date().toISOString(), category: expenseForm.value.category || 'other' }); showExpenseModal.value = false; expenseForm.value.amount = ''; expenseForm.value.title = ''; };
                const triggerDeleteExpense = (id) => { showConfirm('Delete this expense?', () => { expenses.value = expenses.value.filter(e => e.id !== id); }); };
                const clearExpenses = () => { showConfirm('Clear all expense history?', () => { expenses.value = []; }); };
                const addTraveler = () => travelers.value.push(`Traveler ${String.fromCharCode(65 + travelers.value.length)}`);
                const removeTraveler = (idx) => travelers.value.splice(idx, 1);
                const triggerReset = () => { showConfirm('Reset all app data?', () => { localStorage.clear(); window.location.reload(); }); };
                const resetAllData = () => triggerReset();

                // --- CRITICAL FIX: Trigger these on mount ---
                onMounted(() => {
                    fetchWeather();
                    initSync();
                    
                    // --- Auto-generate Apple Touch Icon (Custom Flat Design) ---
                    // Generates a 180x180 PNG matches the user's uploaded image style
                    const canvas = document.createElement('canvas');
                    canvas.width = 180;
                    canvas.height = 180;
                    const ctx = canvas.getContext('2d');
                    
                    // 1. Background (Cream/Off-white)
                    ctx.fillStyle = '#F8F5F0'; // Light cream color matching the image
                    ctx.beginPath();
                    // Draw a rounded rectangle for the background
                    const r = 36; // border radius
                    const s = 180;
                    ctx.moveTo(r, 0);
                    ctx.lineTo(s - r, 0);
                    ctx.quadraticCurveTo(s, 0, s, r);
                    ctx.lineTo(s, s - r);
                    ctx.quadraticCurveTo(s, s, s - r, s);
                    ctx.lineTo(r, s);
                    ctx.quadraticCurveTo(0, s, 0, s - r);
                    ctx.lineTo(0, r);
                    ctx.quadraticCurveTo(0, 0, r, 0);
                    ctx.fill();
                    
                    // 2. Torii Gate Drawing
                    ctx.fillStyle = '#B02E29'; // Deep Red color from the image
                    
                    // Shift coordinate system to center
                    ctx.translate(90, 95);
                    
                    // A. Pillars (Hashira) - Left & Right
                    // Slightly tapered look
                    const pillarW = 14;
                    const pillarH = 90;
                    const pillarX = 35;
                    
                    // Left Pillar
                    ctx.fillRect(-pillarX - pillarW/2, -30, pillarW, pillarH);
                    // Right Pillar
                    ctx.fillRect(pillarX - pillarW/2, -30, pillarW, pillarH);
                    
                    // B. Top Lintel (Kasagi) - The curved top part
                    ctx.beginPath();
                    const topW = 65; // Half width
                    const topY = -45;
                    ctx.moveTo(-topW, topY);
                    // Curve up
                    ctx.bezierCurveTo(-30, topY + 10, 30, topY + 10, topW, topY);
                    // Ends
                    ctx.lineTo(topW + 2, topY - 14);
                    ctx.bezierCurveTo(30, topY - 4, -30, topY - 4, -topW - 2, topY - 14);
                    ctx.fill();

                    // C. Second Lintel (Nuki) - The straight bar below
                    // Extends slightly past pillars
                    const nukiW = 50; // Half width
                    const nukiH = 11;
                    const nukiY = -15;
                    ctx.fillRect(-nukiW, nukiY, nukiW * 2, nukiH);
                    
                    // D. Center Strut (Gakuzuka)
                    ctx.fillRect(-6, topY, 12, nukiY - topY + 5);

                    // Inject into the link tag
                    const iconUrl = canvas.toDataURL('image/png');
                    const link = document.getElementById('app-icon');
                    if(link) link.href = iconUrl;
                });

                return {
                    activeTab, days, currentDayIndex, currentDayEvents, travelers, expenses, sortedExpenses, totalExpense, debts, showEventModal, showExpenseModal, showSettings, eventForm, expenseForm, isEditing, mapLocations, confirmState, weatherData, currentKyotoWeather, getEventWeather, getWeatherIcon, isUrl, getDayName, formatDateShort, getCategoryColor, getCategoryIcon, getPaidAmount, getTabTitle, addDay, openAddModal, editEvent, saveEvent, deleteEvent, triggerDeleteEvent, closeEventModal, saveExpense, triggerDeleteExpense, clearExpenses, addTraveler, removeTraveler, triggerReset, resetAllData, executeConfirm, exchangeRate, expenseCurrency, locateUser, flyToLocation, openGoogleMaps, mapSplit, startResize, autoFillFlight, flightExpanded, toggleFlight, expenseCategories, getExpenseCategoryIcon, getExpenseCategoryColor, theme, changeTheme, isOnline, isSyncing, errorMessage
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
